#Reusable workflow to generate matrix jobs for deployment to Test APIM instance
name: Publish-Artifacts-to-Test-APIM-Instance-Matrix-Jobs-Controller
run-name: Publish-Artifacts-to-Test-APIM-Instance-Matrix-Jobs-Controller
#Author martin francis kallukalam
on:
  workflow_call:
    inputs:
      MILESTONE_TITLE:
        required: true
        type: string
      API_MANAGEMENT_ENVIRONMENT:
        required: true
        type: string
      BRANCH_TO_DEPLOY_FROM:
        required: true
        type: string
env:
  MILESTONE_PREFIX: ms
  PR_PREFIX: pr
  COMMIT_PREFIX: cid
jobs:
    Validate-Milestone-and-Generate-Matrix-Jobs:
     name: Validate-Milestone-and-Generate-Matrix-Jobs
     environment: ${{ inputs.API_MANAGEMENT_ENVIRONMENT }}
     runs-on: ubuntu-latest
     outputs:
       matrix: ${{ steps.generate-matrix.outputs.matrix }}
     steps:
      - name: Print-Input-From-Calling-Workflow
        id: print-input-from-calling-workflow
        run: |
         echo "milestone is ${{ inputs.MILESTONE_TITLE }}"
         echo "apimanagementenvironment is ${{ inputs.API_MANAGEMENT_ENVIRONMENT }}"
         echo "branch to deploy artifacts from is ${{ inputs.BRANCH_TO_DEPLOY_FROM }}"
      - name: Checkout-Artifacts-Branch
        id: checkout-artifacts-branch
        uses: actions/checkout@v6
        with:
         ref: '${{ inputs.BRANCH_TO_DEPLOY_FROM }}'
         fetch-tags: 'true'
         fetch-depth: 100
      - name: Validate-Milestone
        id: validate-milestone
        continue-on-error: false
        run: |
         TAG_LIST_ARRAY=$(git tag -l "${{ env.MILESTONE_PREFIX }}-${{ inputs.MILESTONE_TITLE }}-*" --sort=-creatordate | jq -Rs 'split("\n") | .[] | select(length > 0)' | jq -s .)
         echo "matrix="$TAG_LIST_ARRAY"" >> $GITHUB_OUTPUT
         if echo "$TAG_LIST_ARRAY" | jq -e 'length == 0'; then
          echo "Tag List is empty.Exiting"
          echo "Tag List is empty.Exiting :thumbsdown:" > $GITHUB_STEP_SUMMARY
          exit 1
         else
          echo "Tag List is not empty.Continuing"
         fi         
      - name: Generate-Matrix
        id: generate-matrix
        continue-on-error: false
        run: |
         TAG_LIST_ARRAY=$(git tag -l "${{ env.MILESTONE_PREFIX }}-${{ inputs.MILESTONE_TITLE }}-*" --sort=-creatordate | jq -Rs 'split("\n") | .[] | select(length > 0)' | jq -s .)
         echo "matrix="$TAG_LIST_ARRAY"" >> $GITHUB_OUTPUT
         if echo "$TAG_LIST_ARRAY" | jq -e 'length == 0'; then
          echo "Tag List is empty.Exiting"
          echo "Tag List is empty.Exiting :thumbsdown:" > $GITHUB_STEP_SUMMARY
          exit 1
         else
          echo "Tag List is not empty.Continuing"
         fi
      - name: Print-Matrix
        env:
          matrixenv: ${{ toJson(steps.generate-matrix.outputs.matrix) }}
        id: print-matrix
        run: |
          echo "${{ toJson(steps.generate-matrix.outputs.matrix) }}"
          echo "$matrixenv"
         
    Publish-Artifacts-to-Test-APIM-For-CommitID:
     #if: ${{ !always() }}
     needs: Validate-Milestone-and-Generate-Matrix-Jobs
     strategy:
      max-parallel: 1
      matrix:
       commitid: ${{ fromJson(needs.Validate-Milestone-and-Generate-Matrix-Jobs.outputs.matrix) }}
     uses: martin2176/ecs-apim-workflows/.github/workflows/publish-to-test-apim.yml@main
     with:
      COMMITID: ${{ matrix.commitid }}
      PUBLISH_ARTIFACTS_CHOICE: "publish-delta-artifacts-in-specific-commit"
      API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: apimartifacts
      CONFIGURATION_YAML_PATH: configuration-publisher-test.yml
      API_MANAGEMENT_ENVIRONMENT: test
      BRANCH_TO_DEPLOY_FROM: ${{ inputs.BRANCH_TO_DEPLOY_FROM }} 
      REFTOCHECKOUTFOR_PUBLISHERCONFIG: test 
