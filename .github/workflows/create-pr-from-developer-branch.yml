#Reusable workflow to create PR from developer branch
name: Create-PR-From-Developer-Branch
run-name: Create-PR-From-Developer-Branch
#Author martin francis kallukalam
on:
  workflow_call:
   inputs:
      REFERENCE_NUMBER:
        description: 'Reference(ticket) number to include in the title of PR and milestone.'     
        required: true
        type: string
        default: 'RITM100000'
      BASE_BRANCH_FOR_PR:
        required: true
        type: string
      HEAD_BRANCH_FOR_PR:
        required: true
        type: string
env:
  HEAD_BRANCH_FOR_PR: ${{ inputs.HEAD_BRANCH_FOR_PR }}
  BASE_BRANCH_FOR_PR: ${{ inputs.BASE_BRANCH_FOR_PR }}
  MILESTONE_TITLE: ${{ inputs.REFERENCE_NUMBER }}
jobs:
  Create-Pull-Request:
    name: Create-Pull-Request
    runs-on: [ubuntu-latest]
    permissions:
     contents: write
     pull-requests: write

    steps:
      - name: Checkout-Artifacts-Branch
        id: Checkout-Artifacts-Branch
        uses: actions/checkout@v4
        with:
         ref: '${{ env.BASE_BRANCH_FOR_PR }}'
         fetch-depth: 1
         fetch-tags: 'false'
        
      - name: Create-Or-Get-MileStone
        id: Create-Or-Get-MileStone
        uses: sv-tools/create-milestone-action@v2.0.0
        with:
         token: ${{ secrets.GITHUB_TOKEN }}
         title: "${{ env.MILESTONE_TITLE }}"
         description: "This milestone captures all PRs and Issues for the ticket ${{ inputs.REFERENCE_NUMBER }}"
      - name: Get-Current-Time
        id: Get-Current-Time
        run: |
         echo "PR_OPEN_DATE=$(TZ="US/Eastern" date | sed 's/ /-/g' | sed 's/:/-/g')" >> "$GITHUB_OUTPUT"
      - name: Print-Relevant-Info
        id: print-relevant-info
        run: |
         echo "Reference number is ${{ inputs.REFERENCE_NUMBER }}"
         echo "PR base branch is ${{ inputs.BASE_BRANCH_FOR_PR }}"
         echo "PR head branch is ${{ inputs.HEAD_BRANCH_FOR_PR }}"
         echo "PR milestone number is ${{ steps.Create-Or-Get-MileStone.outputs.number }}"
         
      - name: Create-PR-For-Merging-To-Artifacts-Branch
        id: Create-PR-For-Merging-To-Artifacts-Branch
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: '${{ env.HEAD_BRANCH_FOR_PR }}'
          base: '${{ env.BASE_BRANCH_FOR_PR }}'
          commit-message: "Commiting Artifacts from GHA Workflow Run ID:${{ github.run_id }}"
          title: "PR Opened by: ${{ github.triggering_actor }} for: ${{ inputs.REFERENCE_NUMBER }} at: US/Eastern ${{ steps.Get-Current-Time.outputs.PR_OPEN_DATE }}"
          body: |
            This PR is Auto-Generated by GHA Workflow Run ID: ${{ github.run_id }}
            URL to GHA Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          milestone: '${{ steps.Create-Or-Get-MileStone.outputs.number }}'
          
          
