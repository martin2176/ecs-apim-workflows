#Reusable workflow to extract artifacts from Dev APIM instance
name: Extract-Artifacts-from-Dev-APIM
run-name: Extract-Artifacts-from-Dev-APIM
#Author martin francis kallukalam
on:
  workflow_call:
    inputs:
      EXTRACTOR_OPTION:
        required: true
        type: string
      API_SPECIFICATION_FORMAT:
        required: true
        type: string
      REFERENCE_NUMBER:
        required: true
        type: string
      BRANCH_FOR_EXTRACTOR_CONFIG:
        required: true
        type: string
      BASE_BRANCH_FOR_PR:
        required: true
        type: string
      HEAD_BRANCH_FOR_PR:
        required: true
        type: string
      CONFIGURATION_YAML_PATH:
        required: true
        type: string
      API_MANAGEMENT_ENVIRONMENT:
        required: true
        type: string
#EXTRACTOR_OPTION has possible two values listed below
#Extract Selected APIM Artifacts
#Extract All APIM Artifacts
env:
  apiops_release_version: v7.0.0-beta.1.0.0
  #apiops_release_version: v7.0.0-alpha.3.0.1
  Logging__LogLevel__Default: ${{ vars.LOG_LEVEL }}
  DEBUG_STEPS: ${{ vars.DEBUG_STEPS }}
  CONFIGURATION_EXTRACTOR_YAML: ${{ inputs.CONFIGURATION_YAML_PATH }}
  HEAD_BRANCH_FOR_PR: ${{ inputs.HEAD_BRANCH_FOR_PR }}
  BASE_BRANCH_FOR_PR: ${{ inputs.BASE_BRANCH_FOR_PR }}
  MILESTONE_TITLE: ${{ inputs.REFERENCE_NUMBER }}
  AZURE_CLIENT_ID: "cbbb6866-4d3f-414f-a8ea-317e912b8319"
  API_MANAGEMENT_SERVICE_NAME: "feiaz-apim-dev"
  AZURE_RESOURCE_GROUP_NAME: "apim"
  AZURE_SUBSCRIPTION_ID: "db73da55-ad6a-4d59-aeea-bba62c278f2a"
  AZURE_TENANT_ID: "21c9315b-cdc8-41c8-b30d-d4da2c5a804b"
  GH_TOKEN: ${{ github.token }}
jobs:
  Print-User-Selections:
    name: Print-User-Selections
    runs-on: ubuntu-latest
    steps:
      - name: Print-Input-From-Calling-Workflow
        id: print-input-from-callingworkflow
        shell: bash
        run: |
         echo "Configurationyamlpath is ${{ inputs.CONFIGURATION_YAML_PATH }}"
         echo "Head Branch for PR is ${{ inputs.HEAD_BRANCH_FOR_PR }}"
         echo "Base Branch for PR is ${{ inputs.BASE_BRANCH_FOR_PR }}"
         echo "Reference number is ${{ inputs.REFERENCE_NUMBER }}"
         echo "Extractor option is ${{ inputs.EXTRACTOR_OPTION }}"
         echo "APIM environment is ${{ inputs.API_MANAGEMENT_ENVIRONMENT }}"
         echo "API Spec format is ${{ inputs.API_SPECIFICATION_FORMAT }}"
         echo "APIM environment is ${{ inputs.API_MANAGEMENT_ENVIRONMENT }}"
     
  Extract-Artifacts:
    name: Extract-Artifacts
    runs-on: ubuntu-latest
    environment:  ${{ inputs.API_MANAGEMENT_ENVIRONMENT }}
    steps:
      - name: Login-to-Azure-with-Federated-Identity
        id: login-to-azure-with-federated-identity
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      - name: Get-Bearer-Token-for-APIOPS-Publisher
        id: get-bearer-token-for-apiops-publisher
        run: |
          AZURE_BEARER_TOKEN_JSON=$(az account get-access-token --resource https://management.azure.com/ | jq -r '.')
          AZURE_BEARER_TOKEN=$(echo "$AZURE_BEARER_TOKEN_JSON" | jq -r '.accessToken')
          echo "AZURE_BEARER_TOKEN="$AZURE_BEARER_TOKEN"" >> $GITHUB_ENV
          #Publisher apiops uses this env variable for authentication    
      - name: Checkout-Extractor-Config-Branch
        id: checkout-extractor-config-branch
        uses: actions/checkout@v6
        with:
         ref: '${{ inputs.BRANCH_FOR_EXTRACTOR_CONFIG }}'
      - name: Print-Input-From-Calling-Workflow
        id: print-input-from-callingworkflow
        shell: bash
        run: |
         echo "configurationyamlpath is ${{ inputs.CONFIGURATION_YAML_PATH }}"
         echo "Head Branch for PR is ${{ inputs.HEAD_BRANCH_FOR_PR }}"
         echo "Base Branch for PR is ${{ inputs.BASE_BRANCH_FOR_PR }}"
      - name: Print-PS-Environment-Variables
        if: ${{ env.DEBUG_STEPS == 'true' }} 
        id: printpsenvironmentvariables
        shell: pwsh      
        run: |
          Write-Information "Printing out all environment variables in the shell for debugging purpose"
          gci env:
      - name: Run-Extractor
        id: run-extractor
        shell: pwsh
        env:
          # Other env variables are not added explicitly because they are assigned by workflow
          API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: ${{ runner.temp }}/apimartifacts
          API_SPECIFICATION_FORMAT: ${{ inputs.API_SPECIFICATION_FORMAT }}
        run: |
          $var1="${{ inputs.EXTRACTOR_OPTION }}"
          $var2="Extract All APIM Artifacts"
          $var3="Extract Selected APIM Artifacts"
          if ($var1 -eq $var3) 
          {
          Write-Output "User have chosen to extract Selected APIM Artifacts"
          echo "Copying extractor configuration file to runner.temp"
          #copy configuration-extractor.yaml $env:RUNNER_TEMP
          Write-Output "Configuration yaml path is ${{ env.CONFIGURATION_EXTRACTOR_YAML }}"
          Write-Output "Configuration yaml path is ${{ inputs.CONFIGURATION_YAML_PATH }}"
          copy ${{ env.CONFIGURATION_EXTRACTOR_YAML }} $env:RUNNER_TEMP/configuration-extractor.yaml
          $env:CONFIGURATION_YAML_PATH="$env:RUNNER_TEMP/configuration-extractor.yaml"
          Write-Output "Configuration yaml path is $env:CONFIGURATION_YAML_PATH"
          Write-Output "Api management service output folder path is $env:API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH"
          }
          else
          {
          Write-Output "User have chosen to extract All APIM Artifacts"
          #Write-Output "Configuration yaml path is $env:CONFIGURATION_YAML_PATH"
          Write-Output "Configuration yaml path is null. because extracting all artifacts"
          Write-Output "Api management service output folder path is $env:API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH"
          }
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $VerbosePreference = "Continue"
          $InformationPreference = "Continue"

          Write-Information "Setting name variables..."
          $releaseFileName = "extractor-linux-x64.zip"
          $executableFileName = "extractor"

          if ("${{ runner.os }}" -like "*win*") {
            $releaseFileName = "extractor-win-x64.zip"
            $executableFileName = "extractor.exe"
          }
          elseif ("${{ runner.os }}" -like "*mac*" -and "${{ runner.arch }}" -like "*arm*") {
            $releaseFileName = "extractor-osx-arm64.zip"
          }
          elseif ("${{ runner.os }}" -like "*mac*" -and "${{ runner.arch }}" -like "*x86_64*") {
            $releaseFileName = "extractor-osx-x64.zip"
          }

          Write-Information "Downloading release..."
          $uri = "https://github.com/Azure/apiops/releases/download/${{ env.apiops_release_version }}/$releaseFileName"
          $downloadFilePath = Join-Path "${{ runner.temp }}" $releaseFileName
          Invoke-WebRequest -Uri "$uri" -OutFile "$downloadFilePath"

          Write-Information "Extracting release..."
          $executableFolderPath = Join-Path "${{ runner.temp }}" "extractor"
          Expand-Archive -Path "$downloadFilePath" -DestinationPath "$executableFolderPath"
          $executableFilePath = Join-Path "$executableFolderPath" $executableFileName

          Write-Information "Setting file permissions..."
          if ("${{ runner.os }}" -like "*linux*")
          {
            & chmod +x "$executableFilePath"
            if ($LASTEXITCODE -ne 0) { throw "Setting file permissions failed."}
          }
          echo "---------------------EXTRACTOR CONFIGURATION -------------------------"
          cat $env:CONFIGURATION_YAML_PATH
          echo "----------------------------------------------------------------------"
          Write-Information "Running extractor..."
          & "$executableFilePath"              
          if ($LASTEXITCODE -ne 0) { throw "Running extractor failed."}

          Write-Information "Execution complete."
          ls -R $env:API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH || true


      - name: Upload-Artifact
        id: upload-artifact
        uses: actions/upload-artifact@v6
        env:
         API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: ${{ runner.temp }}/apimartifacts 
        with:
          name: artifact-extract-from-dev-apim-instance
          path: ${{ env.API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH }}
          overwrite: 'false'

  Create-Pull-Request:
    name: Create-Pull-Request
    outputs:
     pr_url: ${{ steps.get-pr-url.outputs.pr_url }}    
    needs: Extract-Artifacts
    runs-on: [ubuntu-latest]
    permissions:
     contents: write
     pull-requests: write

    steps:
      - name: Checkout-Artifacts-Branch
        id: checkout-artifacts-branch
        uses: actions/checkout@v6
        with:
         ref: '${{ env.BASE_BRANCH_FOR_PR }}'
         fetch-depth: 1
         fetch-tags: 'false'
        
      - name: Download-Artifacts-From-Job
        id: download-artifacts-from-job
        uses: actions/download-artifact@v6
        env:
         API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: apimartifacts
        with:
          name: artifact-extract-from-dev-apim-instance
          path: "${{ GITHUB.WORKSPACE }}/${{ env.API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH }}"
      - name: Install-GH-Milestone-Extension
        id: install-gh-milestone-extension
        run: |
         echo "Installing milestone gh extension."
         gh extension install valeriobelli/gh-milestone
      - name: Create-Or-Get-MileStone
        id: create-or-get-milestone
        continue-on-error: false
        run: |
          MILESTONE_COUNT=$(gh milestone list  --state all -q "${{ inputs.REFERENCE_NUMBER }}" --json title |jq '.[] | select(.title == "${{ inputs.REFERENCE_NUMBER }}")'  |jq -s '[.[]]'  | jq '. | length')
          if [ "$MILESTONE_COUNT" -eq 1 ]; then
           echo "Milestone ${{ inputs.REFERENCE_NUMBER }} exist.Continuing without creating a new milestone."
          else
           echo "Milestone doesnot exist.Creating a new milestone ${{ inputs.REFERENCE_NUMBER }}"
           gh milestone create --title "${{ inputs.REFERENCE_NUMBER }}"
          fi
          echo "title=${{ inputs.REFERENCE_NUMBER }}" >> "$GITHUB_OUTPUT"
          echo "number=$(gh milestone list  -q "${{ inputs.REFERENCE_NUMBER }}" --state all --json number,title --jq '.[] | select(.title == "${{ inputs.REFERENCE_NUMBER }}") | .number')" >> "$GITHUB_OUTPUT"        
      - name: Get-Current-Time
        id: get-current-time
        run: |
         echo "PR_OPEN_DATE=$(TZ="US/Eastern" date  +"EST-%Y-%m-%d-%H-%M-%S")" >> "$GITHUB_OUTPUT"
         
      - name: Create-PR-For-Merging-To-Artifacts-Branch
        id: create-pr-for-merging-to-artifacts-branch
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: '${{ env.HEAD_BRANCH_FOR_PR }}'
          base: '${{ env.BASE_BRANCH_FOR_PR }}'
          commit-message: "Commiting Artifacts from GHA Workflow Run ID:${{ github.run_id }}"
          title: "PR Opened by: ${{ github.triggering_actor }} for: ${{ inputs.REFERENCE_NUMBER }} at: ${{ steps.get-current-time.outputs.PR_OPEN_DATE }}"
          body: |
            This PR is Auto-Generated by GHA Workflow Run ID: ${{ github.run_id }}
            URL to GHA Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          milestone: '${{ steps.create-or-get-milestone.outputs.number }}'
      - name: Get-PR-URL
        env:
         GH_TOKEN: ${{ github.token }}
        id: get-pr-url
        run: |
         PR_URL=$(gh pr list --head '${{ inputs.HEAD_BRANCH_FOR_PR }}' --state open --json url --jq '.[].url')
         echo "pr_url="$PR_URL"" >> "$GITHUB_OUTPUT"        
  Notify-MS-Teams:
     name: Notify-MS-Teams
     needs: Create-Pull-Request
     uses: martin2176/ecs-apim-workflows/.github/workflows/msteamsnotification.yml@main
     with:
      CHANNEL_NAME: "PR_APPROVAL_CHANNEL"
      MESSAGE_TITLE: "PR Opened by: ${{ github.triggering_actor }} is ready for review."
      MESSAGE_BODY: "PR Opened by: ${{ github.triggering_actor }} for: ${{ inputs.REFERENCE_NUMBER }} generated by Workflow Run ID: ${{ github.run_id }} is ready for review.You can review the PR at this URL ${{needs.Create-Pull-Request.outputs.pr_url}}"
          
          
          
